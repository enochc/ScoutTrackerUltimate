{%extends 'page_template.html'%}
{% load scouttags%}
{%block head%}

<script>
$(function(){

	$("#unit_button").on('click', function(){
		$("#unit_div").load('/unit/new/', function(){
			$("unit_div").slideDown()
		})
	})
	
	$(".rank_div h2").on('click', function(){
		var div = $(this).parents(".rank_div")
		var table = div.find(".slide_container")
		var html = "+"
		table.slideToggle('fast', function(){
			
			if(table.is(':visible')){
				html = "-"
			}
			div.find("span.toggle").html(html)
		})
	})
	
	{%if perms.userprofile.mark_requirements%}
	
	$('.req.checkbox').on('click', function(){
		var box = $(this)
        openRecForm(box, {postfunc:function(data){
        	afterSet(box, data)
        }})
    })
    {%endif%}
    
    $("#edit_user").on('click', function(){
    	$.blockUI({
    		message:'<div id="block_message"></div>',
    		onBlock:function(){
    			$('#block_message').load('/user/add_scout/{{scout.id}}/?edit=1', function(data){
    				$('div.blockMsg').css({
    					'top':$(window).height()/2 - $('#block_message').height()/2
    				})
    			})
    		}
    	})
		//window.open('/user/add_scout/{{scout.id}}/', 'edit_scout', 'width=400, height=400')
	})
	$('.info').click(function(){
		var link = $(this).attr("ref")
		var box = $(this)
		var info = $("div#info")
		info.css({ 
			'top':box.offset().top,
			'max-width':"800px"
			})
		.find("#info_content").load(link, function(){
			info.css({'left':box.offset().left - info.width()/2})
			.show()
		})
	})
	
	
	
	
	{%if scout.rank.next%}
	$("#sc{{scout.rank.next.order|add:1}}").prev(".rank_div h2").click()

	{%else%}
	$("#sc1").prev(".rank_div h2").click()
	{%endif%}
	
	$("#newpatrol_btn").on("click",function(){
		
		var pn = $("#np_name").val()
		if(pn.length <=2 ){
			alert("Please enter a Patrol name longer then 2 characters")
			return false
		}else{
			$(".rpane").block()
			$.post("/unit/newpatrol/",{"pname":pn},function(data){
				if(!data.success){
					alert(data.message)
					$(".rpane").unblock()
				}else{
					window.location = window.location
				}
			})
		}
	})
})

function afterSet(box, data){

	var row = box.parents("tr")
	if(data.date.length > 0){
		row.find(".date").html(data.date)
	}else{
		row.find(".date").html('')
	}
    var note_row = row.next("tr")
	if(data.notes != null){
		note_row.find(".notes").html(data.notes).end().addClass('full')
	}else{
		note_row.find(".notes").html('').end().removeClass('full')
	}
	
}


</script>
{%endblock%}


{%block content%}

<div id="info" class="popup">
    <span id="close_popup" onclick="close_popup()" title="close">X</span>
    <span id="info_content"></span>
</div>
{%if scout.position.youth%}
	{%include "userprofile/timeline.html"%}
{%endif%}

<div style="float:left;width:39%">


    <div id="edit_user" class='button' style="margin-left:0;">Edit personal info</div>

    <h1>{{scout.fullname}} </h1>
    {%if scout.rank.patch%}<img src='{{MEDIA_URL}}{{scout.rank.patch}}'/>{%endif%}
    {%if scout.position.patch%}<img src='{{MEDIA_URL}}{{scout.position.patch}}'/>{%endif%}
    
    {%if scout.position.youth%}
    {%include 'badges.html'%}
    {%endif%}
    
</div>    
{%if scout.position.youth%}

	<div id="rpane"/>
	   
        {%for r in ranks%}
             <div class="rank_div">
                 <h2><span class='toggle'>+</span>{{r.name}}</h2>
                 <div class="slide_container" id="sc{{r.id}}">
                     <table class="rank_table" id="rank_{{r.id}}"> 
                        {%for req in r.requirements.all%}
                            {%user_requirement%}
                            
                            <tr>
                                <td valign="middle">
                                    <div class="req checkbox s_{{scout.pk}} r_{{req.pk}}">
                                        {%if user_requirement.completed %}<img src='{{MEDIA_URL}}check.png'/>
                                        {%else%}<span class='empty'>&nbsp;</span>{%endif%}
                                    </div>
                                </td>
                                <td><span class="info" ref="/requirement/info/{{req.pk}}/">?</span>{{req.short_desc}}
                                    <span class='date'>{{user_requirement.completed_date|default:''}}</span>
                                </td>
                                
                            </tr>
                            <tr class='r_{{req.id}} tr_notes {%if user_requirement.notes%}full{%endif%}'>
                                <td>&nbsp;</td>
                                <td ><span class='notes'>{{user_requirement.notes|default:''|safe}}</span></td>
                            </tr>
                           
                        {%endfor%}
                    </table>
                    <img class="rank_img" src='{{r.patch.url}}'/>
                </div>
            </div>
        {%endfor%}
	
	    
	</div>
	
	<div id="set_req_form" class="popup">
	</div> 

{% else %}
	<!-- Is a parent or guardian or scout leader-->
	
		{% if user.profile.unit = None%}
		<div id="user_help">
			<fieldset class="float_panel"><legend>Join a Unit</legend>
			For security purposes you can only join a unit via an invitation. Eventually I'll have a search option here where you can 
			search for local unitss and request to be invited. Until that happens you must contact one of your local Scout Representatives
			and ask them to add you to there units.
			</fieldset>
			<br/>
			<fieldset class="float_panel"><legend>Create a Unit</legend>
			If you are a scout leader or a committee member and would like to start using Ultimate scout Tracker then click 
			<span class="link" id="unit_button">here</span> to create a new unit.
			
			<div id="unit_div">
			 
			</div>
			</fieldset>
			
		</div>	 
		{%else%}
			<div id="rpane">
				
					<h2>Patrols:</h2>
					<div>
					<input type="text" size="50" placeholder="Patrol Name" id="np_name"/>
					<span class="button" id="newpatrol_btn">+ Add Patrol</span>
					</div>
					{%for p in patrols%}
						{{p.name}}
					{%empty%}
						<h1>Oh no! no patrols yet</h1>
					{%endfor%}
				
			</div>
			
		{%endif%}
	</div>
{%endif%}

{%endblock%}
